# ğŸ”¹ nginx-hcpë¼ëŠ” ë³„ë„ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±
apiVersion: v1
kind: Namespace
metadata:
  name: nginx-hcp
---
# ğŸ”¹ Nginx ì„¤ì • ConfigMap (default.conf, nginx.conf)
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-conf
  namespace: nginx-hcp
data:
  default.conf: |
    server {
        listen       8080;
        server_name  localhost;

        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
        }

        error_page  500 502 503 504 /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }
  nginx.conf: |
    worker_processes  auto;
    pid /tmp/nginx.pid;

    events {
        worker_connections  1024;
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        sendfile        on;
        keepalive_timeout  65;

        include /etc/nginx/conf.d/*.conf;
    }
---
# ğŸ”¹ Nginxë¥¼ ì‹¤í–‰í•  Deployment ì •ì˜
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: nginx-hcp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx  # Pod ì„ íƒì— ì‚¬ìš©í•  ë¼ë²¨
  template:
    metadata:
      labels:
        app: nginx  # ìœ„ selectorì™€ ì¼ì¹˜í•´ì•¼ í•¨
    spec:
      initContainers:
        - name: init-html
          image: busybox
          command:
            - sh
            - -c
            - |
              echo '<!DOCTYPE html>
              <html>
              <head><title>Nginx on OpenShift</title></head>
              <body>
              <h1>Hello from Latest Nginx on OpenShift - $(POD_NAME)</h1>
              </body>
              </html>' > /html/index.html
          volumeMounts:
            - name: nginx-html
              mountPath: /html
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
      containers:
        - name: nginx
          image: nginx:latest
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: nginx-conf
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
            - name: nginx-main-conf
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
            - name: nginx-cache
              mountPath: /var/cache/nginx
            - name: nginx-html
              mountPath: /usr/share/nginx/html
      volumes:
        - name: nginx-conf
          configMap:
            name: nginx-conf
        - name: nginx-main-conf
          configMap:
            name: nginx-conf
        - name: nginx-cache
          emptyDir: {}
        - name: nginx-html
          emptyDir: {}
---
# ğŸ”¹ Cluster ë‚´ë¶€ì—ì„œ nginx Podë¡œ íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•  Service ìƒì„±
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  namespace: nginx-hcp
spec:
  selector:
    app: nginx  # nginx Deploymentì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¼ë²¨ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
  ports:
    - name: http
      port: 80         # í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•  í¬íŠ¸
      targetPort: 8080   # nginx ì»¨í…Œì´ë„ˆì—ì„œ ë…¸ì¶œí•œ í¬íŠ¸
      protocol: TCP
  type: ClusterIP      # ê¸°ë³¸ ì„œë¹„ìŠ¤ íƒ€ì… (í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥)
---
# ğŸ”¹ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ OpenShift Route ìƒì„±
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: nginx-route-default
  namespace: nginx-hcp
spec:
  to:
    kind: Service
    name: nginx-service  # ìœ„ì—ì„œ ì •ì˜í•œ Serviceì™€ ì—°ê²°
  port:
    targetPort: http     # Serviceì˜ í¬íŠ¸ ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
# ğŸ”¹ ì»¤ìŠ¤í…€ ë„ë©”ì¸ìš© route ì„¤ì •
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: nginx-route-custom
  namespace: nginx-hcp
spec:
  host: oc.naddong.shop
  to:
    kind: Service
    name: nginx-service
  port:
    targetPort: http

